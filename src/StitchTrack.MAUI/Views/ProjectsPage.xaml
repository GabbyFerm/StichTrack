<?xml version="1.0" encoding="utf-8" ?>
<ContentPage xmlns="http://schemas.microsoft.com/dotnet/2021/maui"
             xmlns:x="http://schemas.microsoft.com/winfx/2009/xaml"
             xmlns:toolkit="http://schemas.microsoft.com/dotnet/2022/maui/toolkit"
             xmlns:viewModels="clr-namespace:StitchTrack.Application.ViewModels;assembly=StitchTrack.Application"
             xmlns:entities="clr-namespace:StitchTrack.Domain.Entities;assembly=StitchTrack.Domain"
             x:Class="StitchTrack.MAUI.Views.ProjectsPage"
             x:DataType="viewModels:ProjectsViewModel"
             BackgroundColor="{AppThemeBinding Light={StaticResource LightPageBackground}, Dark={StaticResource DarkPageBackground}}"
             Shell.NavBarIsVisible="False">

  <Grid RowDefinitions="Auto,Auto,*"
        RowSpacing="0">

    <!-- ============================================ -->
    <!-- TOP BAR:   Logo + Sync Icon                    -->
    <!-- ============================================ -->
    <Grid Grid.Row="0"
          BackgroundColor="{AppThemeBinding Light={StaticResource LightAppBackground}, Dark={StaticResource DarkAppBackground}}"
          Padding="30,30"
          ColumnDefinitions="*,Auto"
          ColumnSpacing="15">

      <!-- Logo -->
      <Image Grid.Column="0"
             Source="logo.svg"
             HeightRequest="35"
             HorizontalOptions="Start"
             Aspect="AspectFit" />

      <!-- Sync Icon -->
      <Image Grid.Column="1"
             Source="refresh.svg"
             HeightRequest="24"
             WidthRequest="24"
             HorizontalOptions="End"
             VerticalOptions="Center">
        <Image.Behaviors>
          <toolkit:IconTintColorBehavior TintColor="White" />
        </Image.Behaviors>
        <Image.GestureRecognizers>
          <TapGestureRecognizer Command="{Binding SyncCommand}" />
        </Image.GestureRecognizers>
      </Image>

    </Grid>

    <!-- ============================================ -->
    <!-- PAGE TITLE with Yellow Background            -->
    <!-- ============================================ -->
    <Grid Grid.Row="1"
          BackgroundColor="{AppThemeBinding Light={StaticResource LightAppBackground}, Dark={StaticResource DarkAppBackground}}"
          HeightRequest="60"
          Padding="20,15">

      <!-- MY PROJECTS Title -->
      <Label Text="MY PROJECTS"
             Style="{StaticResource HeaderTitle}"
             HorizontalOptions="Start"
             VerticalOptions="Center" />

      <!-- Buttons Container (Right-aligned) -->
      <HorizontalStackLayout HorizontalOptions="End"
                             VerticalOptions="Center"
                             Spacing="15">

        <!-- Add Button -->
        <Image Source="plus.svg"
               HeightRequest="24"
               WidthRequest="24">
          <Image.Behaviors>
            <toolkit:IconTintColorBehavior TintColor="White" />
          </Image.Behaviors>
          <Image.GestureRecognizers>
            <TapGestureRecognizer Command="{Binding CreateProjectCommand}" />
          </Image.GestureRecognizers>
        </Image>

        <!-- Search Button -->
        <Image Source="search.svg"
               HeightRequest="24"
               WidthRequest="24">
          <Image.Behaviors>
            <toolkit:IconTintColorBehavior TintColor="White" />
          </Image.Behaviors>
          <Image.GestureRecognizers>
            <TapGestureRecognizer Command="{Binding SearchCommand}" />
          </Image.GestureRecognizers>
        </Image>

      </HorizontalStackLayout>

    </Grid>

    <!-- ============================================ -->
    <!-- MAIN CONTENT                                 -->
    <!-- ============================================ -->
    <Grid Grid.Row="2" RowDefinitions="Auto,*">

      <!-- Filter Tabs:   Active | Archived -->
      <VerticalStackLayout Grid.Row="0" Spacing="0">

        <!-- Tab Labels -->
        <Grid Padding="20,20,20,10"
        ColumnDefinitions="*,*">
          <!-- Active Projects Tab (Left) -->
          <Label Grid.Column="0"
                 Text="{Binding ActiveProjectsTabText}"
                 FontFamily="MontserratMedium"
                 FontSize="16"
                 HorizontalOptions="Start"
                 TextColor="{AppThemeBinding Light={StaticResource LightTextPrimary}, Dark={StaticResource DarkTextPrimary}}">
            <Label.Triggers>
              <DataTrigger TargetType="Label"
                           Binding="{Binding ShowArchived}"
                           Value="False">
                <Setter Property="TextColor" Value="{StaticResource BrandGold}" />
                <Setter Property="FontFamily" Value="MontserratSemiBold" />
              </DataTrigger>
            </Label.Triggers>
            <Label.GestureRecognizers>
              <TapGestureRecognizer Command="{Binding ShowActiveProjectsCommand}" />
              </Label.GestureRecognizers>
          </Label>

          <!-- Archived Projects Tab (Right) -->
          <Label Grid.Column="1"
                 Text="{Binding ArchivedProjectsTabText}"
                 FontFamily="MontserratMedium"
                 FontSize="16"
                 HorizontalOptions="End"
                 TextColor="{AppThemeBinding Light={StaticResource LightTextPrimary}, Dark={StaticResource DarkTextPrimary}}">
            <Label.Triggers>
              <DataTrigger TargetType="Label"
                           Binding="{Binding ShowArchived}"
                           Value="True">
                <Setter Property="TextColor" Value="{StaticResource BrandGold}" />
                <Setter Property="FontFamily" Value="MontserratSemiBold" />
              </DataTrigger>
            </Label.Triggers>
            <Label.GestureRecognizers>
              <TapGestureRecognizer Command="{Binding ShowArchivedProjectsCommand}" />
            </Label.GestureRecognizers>
          </Label>

        </Grid>

        <!-- Full-Width Underline Container -->
        <Grid Padding="20,0" ColumnDefinitions="*,*" ColumnSpacing="0">

          <!-- Left Half Underline (Active Projects) -->
          <BoxView Grid.Column="0"
             HeightRequest="2"
             HorizontalOptions="Fill"
             Color="{AppThemeBinding Light={StaticResource LightTextSecondary}, Dark={StaticResource DarkTextSecondary}}">
            <BoxView.Triggers>
              <DataTrigger TargetType="BoxView"
                     Binding="{Binding ShowArchived}"
                     Value="False">
                <Setter Property="Color" Value="{StaticResource BrandGold}" />
              </DataTrigger>
              </BoxView.Triggers>
          </BoxView>

          <!-- Right Half Underline (Archived Projects) -->
          <BoxView Grid.Column="1"
             HeightRequest="2"
             HorizontalOptions="Fill"
             Color="{AppThemeBinding Light={StaticResource LightTextSecondary}, Dark={StaticResource DarkTextSecondary}}">
            <BoxView.Triggers>
              <DataTrigger TargetType="BoxView"
                     Binding="{Binding ShowArchived}"
                     Value="True">
                <Setter Property="Color" Value="{StaticResource BrandGold}" />
              </DataTrigger>
            </BoxView.Triggers>
          </BoxView>

        </Grid>

      </VerticalStackLayout>
      
      <!-- Projects List -->
      <CollectionView Grid.Row="1"
                      ItemsSource="{Binding Projects}"
                      SelectionMode="None"
                      Margin="20,10,20,0">

        <CollectionView.EmptyView>
          <VerticalStackLayout VerticalOptions="Center"
                               HorizontalOptions="Center"
                               Spacing="16"
                               Padding="40">

            <!-- Wool Ball Icon -->
            <Image Source="ball_of_wool.svg"
                   WidthRequest="80"
                   HeightRequest="80"
                   HorizontalOptions="Center" />

            <Label Text="No projects yet"
                   FontFamily="MontserratSemiBold"
                   FontSize="18"
                   HorizontalOptions="Center"
                   TextColor="{AppThemeBinding Light={StaticResource LightTextSecondary}, Dark={StaticResource DarkTextSecondary}}" />

            <Label Text="Tap + to create your first project"
                   FontFamily="MontserratRegular"
                   FontSize="14"
                   HorizontalOptions="Center"
                   TextColor="{AppThemeBinding Light={StaticResource LightTextSecondary}, Dark={StaticResource DarkTextSecondary}}" />

          </VerticalStackLayout>
        </CollectionView.EmptyView>

        <CollectionView.ItemTemplate>
          <DataTemplate x:DataType="entities:Project">

            <Border Padding="12"
                    Margin="0,0,0,16"
                    StrokeThickness="0"
                    BackgroundColor="{AppThemeBinding Light={StaticResource LightCardBackground}, Dark={StaticResource DarkCardBackground}}">

              <Border.StrokeShape>
                <RoundRectangle CornerRadius="12" />
              </Border.StrokeShape>

              <Grid ColumnDefinitions="80,*,Auto" ColumnSpacing="12">

                <Grid.GestureRecognizers>
                  <TapGestureRecognizer 
                    Command="{Binding Source={RelativeSource AncestorType={x:Type viewModels:ProjectsViewModel}}, Path=NavigateToProjectCommand}"
                    CommandParameter="{Binding Id}" />
                  </Grid.GestureRecognizers>

                <!-- Project Image -->
                <Border Grid.Column="0"
                        WidthRequest="80"
                        HeightRequest="80"
                        StrokeThickness="0"
                        BackgroundColor="{AppThemeBinding Light=#E5E7EB, Dark=#374151}"
                        VerticalOptions="Start">

                  <Border.StrokeShape>
                    <RoundRectangle CornerRadius="8" />
                  </Border.StrokeShape>

                  <!-- Wrap both images in a Grid (Border can only have 1 child) -->
                  <Grid>
                    <!-- Show placeholder if no image -->
                    <Image Source="project_placeholder.png"
                           Aspect="AspectFill"
                           IsVisible="{Binding ImagePath, Converter={StaticResource IsStringNullOrEmptyConverter}}" />

                    <!-- Show actual image if available -->
                    <Image Source="{Binding ImagePath}"
                           Aspect="AspectFill"
                           IsVisible="{Binding ImagePath, Converter={StaticResource IsStringNotNullOrEmptyConverter}}" />
                  </Grid>

                </Border>


                <!-- Project Info -->
                <VerticalStackLayout Grid.Column="1"
                                     Spacing="6"
                                     VerticalOptions="Center">

                  <!-- Project Name -->
                  <Label Text="{Binding Name}"
                         FontFamily="MontserratSemiBold"
                         FontSize="16"
                         LineBreakMode="TailTruncation"
                         TextColor="{AppThemeBinding Light={StaticResource LightTextPrimary}, Dark={StaticResource DarkTextPrimary}}" />

                  <!-- Row Count with Progress -->
                  <HorizontalStackLayout Spacing="8">

                    <Label FontFamily="MontserratRegular"
                           FontSize="14"
                           TextColor="{AppThemeBinding Light={StaticResource LightTextSecondary}, Dark={StaticResource DarkTextSecondary}}">
                      <Label.Text>
                        <MultiBinding StringFormat="Row {0}{1}">
                          <Binding Path="CurrentCount" />
                          <Binding Path="TotalRows" Converter="{StaticResource TotalRowsConverter}" />
                        </MultiBinding>
                        </Label.Text>
                    </Label>

                    <!-- Progress Percentage (only if TotalRows is set) -->
                    <Label FontFamily="MontserratMedium"
                           FontSize="14"
                           TextColor="{StaticResource BrandGold}"
                           IsVisible="{Binding TotalRows, Converter={StaticResource IsNotNullConverter}}">
                      <Label.Text>
                        <MultiBinding StringFormat="// {0}% done">
                          <Binding Path="." Converter="{StaticResource ProgressPercentageConverter}" />
                        </MultiBinding>
                        </Label.Text>
                    </Label>

                  </HorizontalStackLayout>

                  <!-- Last Updated -->
                  <Label FontFamily="MontserratRegular"
                         FontSize="12"
                         TextColor="{AppThemeBinding Light={StaticResource LightTextSecondary}, Dark={StaticResource DarkTextSecondary}}">
                    <Label.Text>
                      <MultiBinding StringFormat="Last worked on: {0}">
                        <Binding Path="UpdatedAt" Converter="{StaticResource RelativeTimeConverter}" />
                      </MultiBinding>
                      </Label.Text>
                  </Label>

                </VerticalStackLayout>

                <!-- More Options Button -->
                <Image Grid.Column="2"
                       Source="more. svg"
                       WidthRequest="24"
                       HeightRequest="24"
                       VerticalOptions="Start">
                  <Image.Behaviors>
                    <toolkit:IconTintColorBehavior TintColor="{AppThemeBinding Light={StaticResource LightIconColor}, Dark={StaticResource DarkIconColor}}" />
                    </Image.Behaviors>
                    <Image.GestureRecognizers>
                      <!-- TODO:  Implement options menu -->
                      <TapGestureRecognizer />
                    </Image.GestureRecognizers>
                </Image>

              </Grid>

            </Border>

          </DataTemplate>
        </CollectionView.ItemTemplate>

      </CollectionView>

    </Grid>

  </Grid>

</ContentPage>
