name: CD - deploy & notify

on:
  workflow_run:
    workflows: ["CI - build & test", "MAUI - build & publish (macOS)"]
    types:
      - completed

permissions:
  contents: read

jobs:
  deploy-dev:
    if: ${{ github.event.workflow_run.conclusion == 'success' }}
    runs-on: ubuntu-latest
    environment:
      name: dev
    steps:
      - name: Download artifact
        uses: actions/download-artifact@v4
        with:
          name: maui-publish
          path: ./out || true

      - name: Simulate deploy to dev
        run: |
          echo "Deploying ${{ vars.SERVICE_NAME }} to dev"
          ls -la ./out || true
          echo "âœ… Dev deployment completed"

      - name: Notify Discord (dev)
        if: ${{ github.event.workflow_run.conclusion == 'success' && secrets.DISCORD_WEBHOOK != '' }}
        env:
          DISCORD_WEBHOOK: ${{ secrets.DISCORD_WEBHOOK }}
        run: |
          echo "::add-mask::${DISCORD_WEBHOOK}"
          payload='{"content":"âœ… Dev deploy succeeded for ${{ vars.SERVICE_NAME }} on branch '"${{ github.event.workflow_run.head_branch }}"'."}'
          curl -H "Content-Type: application/json" -d "$payload" "${DISCORD_WEBHOOK}"

  deploy-prod:
    if: ${{ github.event.workflow_run.conclusion == 'success' && github.event.workflow_run.head_branch == 'main' }}
    runs-on: ubuntu-latest
    environment:
      name: prod
    steps:
      - name: Download artifact
        uses: actions/download-artifact@v4
        with:
          name: maui-publish
          path: ./out || true

      - name: Simulate deploy to prod
        run: |
          echo "Deploying ${{ vars.SERVICE_NAME }} to prod"
          ls -la ./out || true

      - name: Notify Discord (prod)
        env:
          DISCORD_WEBHOOK: ${{ secrets.DISCORD_WEBHOOK }}
        run: |
          echo "::add-mask::${DISCORD_WEBHOOK}"
          payload='{"content":"ðŸš€ Prod deploy completed for ${{ vars.SERVICE_NAME }}."}'
          curl -H "Content-Type: application/json" -d "$payload" "${DISCORD_WEBHOOK}"
