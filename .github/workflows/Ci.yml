name: CI - Build & Test

on:
  push:
    branches: [develop, main]
  pull_request:
    branches: [develop, main]
  workflow_dispatch:

permissions:
  contents: read

env:
  DOTNET_CLI_TELEMETRY_OPTOUT: '1'
  DOTNET_SKIP_FIRST_TIME_EXPERIENCE: '1'

jobs:
  # Job 1: Build and test class libraries (fast, cross-platform)
  build-libs:
    name: Build Libraries & Tests
    runs-on: ubuntu-latest
    
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Setup .NET 9
        uses: actions/setup-dotnet@v4
        with:
          dotnet-version: '9.0.x'

      - name: Cache NuGet packages
        uses: actions/cache@v4
        with:
          path: ~/.nuget/packages
          key: ${{ runner.os }}-nuget-${{ hashFiles('**/*.csproj') }}
          restore-keys: |
            ${{ runner.os }}-nuget-

      - name: Restore dependencies
        run: dotnet restore StitchTrack.sln

      - name: Build Core libraries
        run: |
          dotnet build src/StitchTrack.Core/StitchTrack.Core.csproj -c Release --no-restore
          dotnet build src/StitchTrack.Application/StitchTrack.Application.csproj -c Release --no-restore
          dotnet build src/StitchTrack.Infrastructure/StitchTrack.Infrastructure.csproj -c Release --no-restore

      - name: Build Test projects
        run: |
          dotnet build tests/StitchTrack.UnitTests/StitchTrack.UnitTests.csproj -c Release --no-restore
          dotnet build tests/StitchTrack.IntegrationTests/StitchTrack.IntegrationTests.csproj -c Release --no-restore

      - name: Run Unit Tests
        run: dotnet test tests/StitchTrack.UnitTests/StitchTrack.UnitTests.csproj --no-build -c Release --verbosity normal

      - name: Run Integration Tests
        run: dotnet test tests/StitchTrack.IntegrationTests/StitchTrack.IntegrationTests.csproj --no-build -c Release --verbosity normal

  # Job 2: Build MAUI Android (Windows runner - fastest for Android)
  build-android:
    name: Build Android
    runs-on: windows-latest
    needs: build-libs
    
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Setup .NET 9
        uses: actions/setup-dotnet@v4
        with:
          dotnet-version: '9.0.x'

      - name: Install MAUI Workload
        run: dotnet workload install maui-android --skip-manifest-update

      - name: Restore solution
        run: dotnet restore StitchTrack.sln

      - name: Build Android App
        run: dotnet build src/StitchTrack.App/StitchTrack.App.csproj -f net9.0-android -c Release

      - name: Publish Android (unsigned)
        run: |
          mkdir -p artifacts/android
          dotnet publish src/StitchTrack.App/StitchTrack.App.csproj `
            -f net9.0-android `
            -c Release `
            -o artifacts/android `
            /p:AndroidPackageFormat=apk

      - name: Upload Android APK
        uses: actions/upload-artifact@v4
        with:
          name: android-apk
          path: artifacts/android/**/*.apk
          retention-days: 7

  # Job 3: Build MAUI iOS (macOS runner required)
  build-ios:
    name: Build iOS
    runs-on: macos-latest
    needs: build-libs
    
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Setup .NET 9
        uses: actions/setup-dotnet@v4
        with:
          dotnet-version: '9.0.x'

      - name: Install MAUI Workload
        run: dotnet workload install maui-ios --skip-manifest-update

      - name: Restore solution
        run: dotnet restore StitchTrack.sln

      - name: Build iOS App
        run: dotnet build src/StitchTrack.App/StitchTrack.App.csproj -f net9.0-ios -c Release

  # Job 4: Build MAUI Windows (Windows runner)
  build-windows:
    name: Build Windows
    runs-on: windows-latest
    needs: build-libs
    
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Setup .NET 9
        uses: actions/setup-dotnet@v4
        with:
          dotnet-version: '9.0.x'

      - name: Install MAUI Workload
        run: dotnet workload install maui-windows --skip-manifest-update

      - name: Restore solution
        run: dotnet restore StitchTrack.sln

      - name: Build Windows App
        run: dotnet build src/StitchTrack.App/StitchTrack.App.csproj -f net9.0-windows10.0.19041.0 -c Release
